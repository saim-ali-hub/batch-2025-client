#!/bin/bash

echo -e "\n\e[36mLINOOP TEK INNOVATIONS RHCSA EVALUATION 2025 TOOL STARTING\nKEEP CALM AND SIT TIGHT\e[0m"
echo -e "\n\e[37m***********************RUNNING NOW******************************\n\e[0m"

: ' This Script evaluate students tasks
    - check root pw			        --DONE
    - check static IP   	        --DONE
    - check webimage25		        --DONE
    - check_webimage                --DONE
    - check web container1	     	--DONE
    - check myweb                   --DONE
    - check pdf file conversion     --DONE
    - check repos			        --DONE
    - check chrony			        --DONE
  '
if [ `id -u` != 0 ];then
        echo ""
        echo -e "\e[31mFailed: Please Run this Script as root\e[0m\n"
        exit 1
fi
###############################################################################
check_pw() {
   echo "Check Q1 Checking Root PW........"

   # Install sshpass if not already installed
   if ! command -v sshpass &>/dev/null; then
      dnf install -q -y sshpass &>/dev/null
      if [ $? -ne 0 ]; then
         echo -e "\e[31mFailed to install sshpass. Exiting.\e[0m"
         exit 1
      fi
   fi

   # Update sshd config
   sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
   sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

   systemctl restart sshd &>/dev/null
   if [ $? -ne 0 ]; then
      echo -e "\e[31mFailed to restart sshd. Exiting.\e[0m"
      exit 1
   fi

   # Try logging in with root password
   sshpass -p 'redhat' ssh -o StrictHostKeyChecking=no root@localhost 'pwd >/dev/null' &>/dev/null
   if [ $? -eq 0 ]; then
      echo -e "\e[32mRoot_PW_Check: Pass\e[0m\n"
   else
      echo -e "\e[31mRoot_PW_Check: Fail\e[0m\n"
   fi
}

###############################################################################
check_interface() {
    if ip link show "$1" > /dev/null 2>&1; then
       echo -e "\nNetwork interface $1 exists.\n"
       #echo -e "          Running Validation"
       #echo -e "------------------------------------------\n"
       return 0
    else
       echo -e "\e[31mNetwork interface $1 does not exist. Please try again.\e[0m\n"
       return 1
    fi
}
################################################################################
check_IP() {
    echo "Check Q2 Checking Root PW........"
   while true; do
      read -p "Please Enter your network card name (e.g., enp0s3, ens): " n_card
      check_interface "$n_card" && break
   done

   ip_test=$(nmcli con show "$n_card" | grep ipv4.method | awk '{print $2}')

   echo -n "Checking IP"
   for i in {1..10}; do
       echo -n "."
       sleep 0.1
   done
   echo ""

   if [ -z "$ip_test" ]; then
       echo -e "\e[31mCould not determine IP method for interface $n_card\e[0m\n"
       return 1
   fi

   if [ "$ip_test" == "manual" ]; then
        echo -e "\e[32mIP_Check: PASS\e[0m\n"
   else
        echo -e "\e[31mIP_Check: FAIL\e[0m\n"
   fi
}

###################################################################################
check__webimage25(){
    echo "Check Q3 (a): Container image webimage25..."

    su - frank -c "podman images --format '{{.Repository}}' | grep -E '(^|/)webimage25$'" &>/dev/null
    st=$?

    if [ $st -eq 0 ]; then
        echo -e "\e[32mCheck Q3a webimage25: Pass\e[0m\n"
    else
        echo -e "\e[31mCheck Q3a webimage25: Fail\e[0m\n"
    fi
}
check_webimage(){
    echo "Check Q3 (b): Container image webimage..."
    su - frank -c "podman images --format '{{.Repository}}' | grep -E '(^|/)webimage$'" &>/dev/null
    st=$?

    if [ $st -eq 0 ]; then
        echo -e "\e[32mCheck Q3(b) webimage: Pass\e[0m\n"
    else
        echo -e "\e[31mCheck Q3(b) webimage: Fail\e[0m\n"
    fi
}
################################################################################
check_container25(){
    echo "Check Q4 (a): Container25 (user: frank) ====="
echo

FAIL_MSG=""
ALL_PASS=true

# Rootless container storage path
export XDG_RUNTIME_DIR="/run/user/$(id -u frank)"

### 1. Check container exists
if ! sudo -u frank podman container inspect container25 &>/dev/null; then
    FAIL_MSG+="[FAIL] Container 'container25' does not exist (for user frank).\n"
    ALL_PASS=false
fi

### 2. Check correct image
if sudo -u frank podman container inspect container25 &>/dev/null; then
    IMAGE=$(sudo -u frank podman inspect container25 --format '{{.Config.Image}}')                    
     if [[ "$IMAGE" != "webimage25" && "$IMAGE" != "localhost/webimage25" && "$IMAGE" != "localhost/webimage25:latest"  ]]; then
        FAIL_MSG+="[FAIL] Wrong image used. Expected: webimage25 or localhost/webimage25 or localhost/webimage25:latest, Found: $IMAGE\n"
        ALL_PASS=false
    fi
fi

### 3. Check mount /opt/mydata:/opt/newdata
if ! sudo -u frank podman inspect container25 | grep -q '"Source": "/opt/mydata", "Destination": "/opt/newdata"'; then
    FAIL_MSG+="[FAIL] Missing mount: /opt/mydata:/opt/newdata.\n"
    ALL_PASS=false
fi

### 4. Check mount /opt/web:/var/www/html
if ! sudo -u frank podman inspect container25 | grep -q '"Source": "/opt/web", "Destination": "/var/www/html"'; then
    FAIL_MSG+="[FAIL] Missing mount: /opt/web:/var/www/html.\n"
    ALL_PASS=false
fi

### 5. Check port mapping 9092:8080
if ! sudo -u frank podman inspect container25 | grep -q '"8080/tcp": \[{"HostPort": "9092"}\]'; then
    FAIL_MSG+="[FAIL] Port mapping incorrect or missing: expected 9092:8080.\n"
    ALL_PASS=false
fi

### 6. Check systemd service file exists
SERVICE_FILE="/home/frank/.config/systemd/user/container-container25.service"
if [ ! -f "$SERVICE_FILE" ]; then
    FAIL_MSG+="[FAIL] Systemd service file missing: $SERVICE_FILE\n"
    ALL_PASS=false
fi

### 7. Check systemd user service enabled (boot persistent)
if sudo -u frank systemctl --user is-enabled container-container25 &>/dev/null; then
    true
else
    FAIL_MSG+="[FAIL] Systemd service is NOT enabled for boot persistence.\n"
    ALL_PASS=false
fi

### FINAL RESULT
if $ALL_PASS; then
    echo "[PASS] container25 — All validations successful."
else
    echo -e "$FAIL_MSG"
fi
}
check_myweb(){
    echo "Check Q4 (b): Container myweb (user: linda)"
echo

FAIL_MSG=""
ALL_PASS=true

# Ensure rootless environment points to linda user runtime
export XDG_RUNTIME_DIR="/run/user/$(id -u linda)"

### 1. Check container exists
if ! sudo -u linda podman container inspect myweb &>/dev/null; then
    FAIL_MSG+="[FAIL] Container 'myweb' does not exist (for user linda).\n"
    ALL_PASS=false
fi

### 2. Check correct image
if sudo -u linda podman container inspect myweb &>/dev/null; then

    IMAGE=$(sudo -u linda podman inspect myweb --format '{{.Config.Image}}')
    if [[ "$IMAGE" != "webimage" && "$IMAGE" != "localhost/webimage" && "$IMAGE" != "localhost/webimage:latest" ]]; then
        FAIL_MSG+="[FAIL] Wrong image used. Expected: webimage or localhost/webimage or localhost/webimage:latest, Found: $IMAGE\n"
        ALL_PASS=false
    fi
fi

### 3. Check mount /opt/process:/mnt/new
if ! sudo -u linda podman inspect myweb | grep -q '"Source": "/opt/process", "Destination": "/mnt/new"'; then
    FAIL_MSG+="[FAIL] Missing mount: /opt/process:/mnt/new.\n"
    ALL_PASS=false
fi

### 4. Check mount /opt/action:/mnt/old
if ! sudo -u linda podman inspect myweb | grep -q '"Source": "/opt/action", "Destination": "/mnt/old"'; then
    FAIL_MSG+="[FAIL] Missing mount: /opt/action:/mnt/old.\n"
    ALL_PASS=false
fi

### 5. Check port mapping 8085:8080
if ! sudo -u linda podman inspect myweb | grep -q '"8080/tcp": \[{"HostPort": "8085"}\]'; then
    FAIL_MSG+="[FAIL] Port mapping incorrect or missing: expected 8085:8080.\n"
    ALL_PASS=false
fi

### 6. Check systemd service file exists
SERVICE_FILE="/home/linda/.config/systemd/user/container-myweb.service"
if [ ! -f "$SERVICE_FILE" ]; then
    FAIL_MSG+="[FAIL] Systemd service file missing: $SERVICE_FILE\n"
    ALL_PASS=false
fi

### 7. Check systemd user service enabled (boot persistent)
if sudo -u linda systemctl --user is-enabled container-myweb &>/dev/null; then
    true
else
    FAIL_MSG+="[FAIL] Systemd service is NOT enabled for boot persistence.\n"
    ALL_PASS=false
fi

### FINAL RESULT
if $ALL_PASS; then
    echo "[PASS] myweb — All validations successful."
else
    echo -e "$FAIL_MSG"
fi
}

check_pdf_file_conversion(){
    echo "Check Q4 (b): File converted to PDF..."

    [ -f /opt/process/my_file1.pdf ]
    st=$?

    if [ $st -eq 0 ]; then
        echo -e "\e[32mCheck Q4(b) PDF: Pass\e[0m\n"
    else
        echo -e "\e[31mCheck Q4(b) PDF: Fail\e[0m\n"
    fi
}

################################################################################
check_repos(){
   echo "Checking Repositories.........."
app_chk=$(yum repolist enabled | grep -i AppStream | wc -l)
base_chk=$(yum repolist enabled | grep -i BaseOs | wc -l)

   if [ "$app_chk" -eq 0 ];then
     echo -e "\e[31mAPPSTREAM_Check: Fail\e[0m\n"
   else
     echo -e "\e[32mAPPSTREAM_Check: Pass\e[0m\n"
   fi
   if [ "$base_chk" -eq 0 ];then
     echo -e "\e[31mBASEOS_Check: Fail\e[0m\n"
   else
     echo -e "\e[32mBASEOS_Check: Pass\e[0m\n"
   fi
}
#####################################################################################
check_chrony() {
    echo "Checking Chrony service..."
    
    # Service check
    if systemctl is-active --quiet chronyd; then
        echo -e "\e[32mChrony service: Active\e[0m"
    else
        echo -e "\e[31mChrony service: Inactive\e[0m"
        return 1
    fi

    # Synchronization check
    leap_status=$(chronyc tracking | grep "Leap status" | awk '{print $3}')
    if [ "$leap_status" = "Normal" ]; then
        echo -e "\e[32mChrony sync: OK : Pass\e[0m"
    else
        echo -e "\e[31mChrony sync: Not synchronized : Fail\e[0m"
        chronyc sources -v
        return 1
    fi
}
######################################################################################
